<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lean Coffee | Agile Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-card: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --primary: #38bdf8;
            --primary-hover: #0ea5e9;
            --success: #4ade80;
            --danger: #f87171;
            --border: #475569;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            padding: 0.8rem 1rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
            z-index: 100;
        }

        .brand { display: flex; align-items: center; gap: 8px; }
        .brand h1 { font-size: 1rem; font-weight: 700; margin: 0; letter-spacing: -0.025em; white-space: nowrap; }
        
        .timer-section {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            gap: 8px;
        }

        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            min-width: 55px;
            text-align: center;
        }
        .timer-display.finished { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .timer-input {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-primary); padding: 4px; border-radius: 4px;
            width: 35px; text-align: center; font-family: inherit; font-size: 1rem;
        }

        .btn-small {
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer; padding: 4px 8px;
            border-radius: 4px; font-size: 0.8rem;
            touch-action: manipulation;
        }
        .btn-primary { background: var(--primary); color: #0f172a; border: none; font-weight: 600; }

        .user-panel { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; font-size: 0.75rem; }
        .stat-pill {
            background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 20px;
            display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1);
        }
        #my-symbol-box { font-size: 1.2rem; line-height: 1; }

        /* --- Controls --- */
        .controls-area {
            padding: 1rem; display: flex; justify-content: center;
            width: 100%; max-width: 800px; margin: 0 auto;
            flex-shrink: 0;
        }

        .input-group {
            display: flex; width: 100%; background: var(--bg-surface);
            padding: 4px; border-radius: 12px; border: 1px solid var(--border);
        }

        #new-card-text {
            flex: 1; background: transparent; border: none; padding: 12px;
            color: var(--text-primary); font-size: 16px; 
            outline: none;
        }

        #add-btn {
            background-color: var(--primary); color: #0f172a; border: none;
            border-radius: 8px; width: 50px; font-weight: 600; cursor: pointer;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            touch-action: manipulation;
        }

        /* --- Board Layout --- */
        .board {
            flex: 1; display: flex; gap: 1rem; padding: 0.5rem 1rem 1rem 1rem;
            overflow-x: auto; 
            overflow-y: hidden;
            scroll-snap-type: x mandatory; 
            align-items: flex-start;
            -webkit-overflow-scrolling: touch;
        }

        .column {
            background-color: var(--bg-surface); border-radius: 12px;
            flex: 0 0 88vw;
            min-width: 300px; max-width: 400px;
            display: flex; flex-direction: column;
            border: 1px solid var(--border);
            height: 100%; 
            scroll-snap-align: center; 
        }

        .column-header {
            padding: 0.8rem 1rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.1);
        }
        .column-header h2 { margin: 0; font-size: 1rem; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); }

        .task-list {
            flex: 1; padding: 0.8rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        /* --- Card Styles --- */
        .card {
            background-color: var(--bg-card); border-radius: 8px; padding: 1rem;
            border-left: 4px solid transparent; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 12px; }
        .card-text { color: var(--text-primary); font-size: 1rem; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap; flex: 1; }
        
        .card-actions-top { display: flex; gap: 15px; }

        .icon-btn {
            background: rgba(255,255,255,0.05); border: none; color: var(--text-muted);
            cursor: pointer; padding: 8px;
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            touch-action: manipulation;
        }
        .delete-btn { color: var(--danger); }

        .move-controls {
            display: flex; justify-content: space-between; margin-top: 12px; 
            border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px;
        }
        
        .move-btn {
            background: none; border: 1px solid var(--border); color: var(--primary);
            border-radius: 6px; cursor: pointer; padding: 8px 16px; font-size: 1rem;
            touch-action: manipulation;
            min-width: 44px;
        }
        .move-btn:disabled { opacity: 0.2; pointer-events: none; }

        .card-bottom {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .card-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; }
        .creator-symbol { font-size: 1.1rem; margin-right: 6px; }

        .vote-pill {
            display: flex; align-items: center; background-color: rgba(0,0,0,0.3);
            border-radius: 24px; padding: 4px; gap: 5px;
        }
        
        .vote-btn {
            background: none; border: none; width: 44px; height: 44px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center;
            justify-content: center; color: var(--text-secondary); font-size: 1.2rem;
            touch-action: manipulation;
        }
        
        .vote-btn:active { background-color: rgba(255,255,255,0.1); transform: scale(0.95); }
        .vote-up { color: var(--success); opacity: 0.7; }
        .vote-up:not(:disabled) { opacity: 1; }
        .vote-down { color: var(--danger); opacity: 0.7; }
        .vote-down:not(:disabled) { opacity: 1; }

        #status { position: fixed; bottom: 10px; right: 10px; font-size: 0.7rem; color: var(--text-muted); background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px; pointer-events: none;}

        @media (min-width: 769px) {
            .board { overflow-x: auto; scroll-snap-type: none; }
            .column { flex: 1; min-width: 300px; max-width: 400px; }
            .move-controls { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div style="font-size: 1.2rem;">‚òï</div>
            <h1>LEAN COFFEE</h1>
        </div>
        
        <div class="timer-section">
            <div id="timer-display" class="timer-display">00:00</div>
            <div class="timer-controls">
                <input type="number" id="timer-input" class="timer-input" value="5" min="1" max="60">
                <button class="btn-small btn-primary" onclick="startTimer()">Start</button>
                <button class="btn-small" onclick="stopTimer()">Stop</button>
            </div>
        </div>

        <div class="user-panel">
            <div class="stat-pill">
                <span style="color:var(--text-muted)">Du:</span>
                <span id="my-symbol-box"></span>
                <span id="my-color-box" style="display:block; width:12px; height:12px; border-radius:50%;"></span> 
            </div>
            <div class="stat-pill">
                <span style="color:var(--text-muted)">R√∂ster:</span>
                <span id="votes-left" style="font-weight:700; color:var(--primary);">5</span>
            </div>
        </div>
    </header>

    <div class="controls-area">
        <div class="input-group">
            <input type="text" id="new-card-text" placeholder="Ny aktivitet...">
            <button id="add-btn">+</button>
        </div>
    </div>

    <div class="board">
        <div class="column" id="col-proposal">
            <div class="column-header"><h2>F√∂rslag</h2><span>üí°</span></div>
            <div class="task-list" id="proposal"></div>
        </div>
        <div class="column" id="col-discuss">
            <div class="column-header"><h2>Diskutera</h2><span>üó£Ô∏è</span></div>
            <div class="task-list" id="discuss"></div>
        </div>
        <div class="column" id="col-done">
            <div class="column-header"><h2>Klart</h2><span>‚úÖ</span></div>
            <div class="task-list" id="done"></div>
        </div>
    </div>

    <div id="status">Connecting...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --------------------------------------------------------------
        // KONFIGURATION
        // --------------------------------------------------------------
        const firebaseConfig = {
		  apiKey: "AIzaSyCHrUufAISfVGwGICTDcVaWGt0vzLVRFpk",
		  authDomain: "team-kanban.firebaseapp.com",
		  databaseURL: "https://team-kanban-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "team-kanban",
		  storageBucket: "team-kanban.firebasestorage.app",
		  messagingSenderId: "457664936790",
		  appId: "1:457664936790:web:a77f6fe962b365fb1034f7"
        };
        // --------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let cards = [];
        const MAX_VOTES = 5;
        const COLUMNS = ['proposal', 'discuss', 'done'];
        
        // --- USER IDENTITY (Color & Symbol) ---
        // Lista p√• trevliga symboler
        const USER_SYMBOLS = ['ü¶ä', 'üêº', 'üê∏', 'üêô', 'ü¶Ñ', 'üêù', 'ü¶â', 'ü¶ã', 'üêû', 'üê†', 'üçÑ', 'üå∏', 'üöÄ', 'üö≤', 'üé∏', 'üéÆ', 'ü§ñ', 'ü¶ñ'];
        
        let userColor = localStorage.getItem('userColor');
        let userSymbol = localStorage.getItem('userSymbol');

        // Om anv√§ndaren inte har f√§rg/symbol, skapa nya
        if (!userColor || !userSymbol) {
             userColor = '#' + Math.floor(Math.random()*16777215).toString(16);
             userSymbol = USER_SYMBOLS[Math.floor(Math.random() * USER_SYMBOLS.length)];
             localStorage.setItem('userColor', userColor);
             localStorage.setItem('userSymbol', userSymbol);
        }

        document.getElementById('my-color-box').style.backgroundColor = userColor;
        document.getElementById('my-color-box').style.boxShadow = `0 0 8px ${userColor}`; // Lite glow
        document.getElementById('my-symbol-box').innerText = userSymbol;

        let myVotedCards = JSON.parse(localStorage.getItem('myVotedCards')) || [];

        // --- TIMER ---
        let timerInterval = null;
        let timerTarget = 0;
        const timerRef = ref(db, 'kanban/timer');

        onValue(timerRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.targetTime) {
                timerTarget = data.targetTime;
                if (!timerInterval) timerInterval = setInterval(updateTimerUI, 1000);
                updateTimerUI();
            } else {
                stopLocalTimer();
                document.getElementById('timer-display').innerText = "00:00";
                document.getElementById('timer-display').classList.remove('finished');
            }
        });

        window.startTimer = function() {
            const val = document.getElementById('timer-input').value;
            if (!val) return;
            const targetTime = Date.now() + (parseInt(val) * 60 * 1000);
            set(timerRef, { targetTime: targetTime });
        };
        window.stopTimer = function() { set(timerRef, null); };
        function stopLocalTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
        function updateTimerUI() {
            const diff = timerTarget - Date.now();
            const display = document.getElementById('timer-display');
            if (diff <= 0) {
                display.innerText = "00:00"; display.classList.add('finished'); return;
            }
            display.classList.remove('finished');
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            display.innerText = (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
        }

        // --- CARDS ---
        const cardsRef = ref(db, 'kanban/cards');
        onValue(cardsRef, (s) => {
            const d = s.val(); cards = d ? d : [];
            cards.sort((a, b) => b.votes - a.votes);
            renderBoard();
        });

        function save() { set(cardsRef, cards); }

        window.createCard = function() {
            const input = document.getElementById('new-card-text');
            const text = input.value.trim();
            if (!text) return;
            // L√§gg till symbolen p√• nya kort
            cards.push({ 
                id: Date.now(), 
                text: text, 
                column: 'proposal', 
                color: userColor, 
                symbol: userSymbol, 
                votes: 0 
            });
            input.value = '';
            save();
        }
        document.getElementById('add-btn').onclick = window.createCard;

        window.editCard = function(id) {
            const c = cards.find(x => x.id === id);
            const txt = prompt("√Ñndra text:", c.text);
            if (txt && txt.trim()) { c.text = txt.trim(); save(); }
        }

        window.deleteCard = function(id) {
            if(confirm("Ta bort?")) {
                cards = cards.filter(x => x.id !== id);
                while(myVotedCards.includes(id)) {
                    myVotedCards.splice(myVotedCards.indexOf(id), 1);
                }
                localStorage.setItem('myVotedCards', JSON.stringify(myVotedCards));
                save();
            }
        }

        window.moveCard = function(id, direction) {
            const c = cards.find(x => x.id === id);
            if (!c) return;
            const currentIndex = COLUMNS.indexOf(c.column);
            let newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < COLUMNS.length) {
                c.column = COLUMNS[newIndex];
                save();
            }
        }

        window.vote = function(id, delta) {
            const c = cards.find(x => x.id === id);
            if (!c) return;
            
            if (delta > 0) { 
                if (myVotedCards.length >= MAX_VOTES) { alert("Slut p√• r√∂ster"); return; }
                c.votes++;
                myVotedCards.push(id);
            } else { 
                if (!myVotedCards.includes(id)) return;
                if (c.votes > 0) c.votes--;
                myVotedCards.splice(myVotedCards.indexOf(id), 1);
            }
            localStorage.setItem('myVotedCards', JSON.stringify(myVotedCards));
            save();
        }

        function renderBoard() {
            document.getElementById('votes-left').innerText = MAX_VOTES - myVotedCards.length;
            COLUMNS.forEach(col => document.getElementById(col).innerHTML = '');
            
            const iEdit = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
            const iTrash = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

            cards.forEach(c => {
                const myVotes = myVotedCards.filter(x => x === c.id).length;
                const colIndex = COLUMNS.indexOf(c.column);
                const canMoveLeft = colIndex > 0;
                const canMoveRight = colIndex < COLUMNS.length - 1;
                
                // Anv√§nd skaparens symbol, eller en gubbe om det √§r ett gammalt kort
                const creatorSymbol = c.symbol || 'üë§';

                const el = document.createElement('div');
                el.className = 'card';
                el.style.borderLeftColor = c.color;
                
                el.innerHTML = `
                    <div class="card-top">
                        <div class="card-text">${c.text}</div>
                        <div class="card-actions-top">
                            <button class="icon-btn" onclick="editCard(${c.id})">${iEdit}</button>
                            <button class="icon-btn delete-btn" onclick="deleteCard(${c.id})">${iTrash}</button>
                        </div>
                    </div>
                    
                    <div class="move-controls">
                        <button class="move-btn" onclick="moveCard(${c.id}, -1)" ${!canMoveLeft?'disabled':''}>‚¨ÖÔ∏è</button>
                        <span style="font-size:0.7rem; opacity:0.5; align-self:center;">FLYTTA</span>
                        <button class="move-btn" onclick="moveCard(${c.id}, 1)" ${!canMoveRight?'disabled':''}>‚û°Ô∏è</button>
                    </div>

                    <div class="card-bottom">
                        <div class="card-meta">
                            <span class="creator-symbol">${creatorSymbol}</span>
                            #${c.id.toString().slice(-4)} ${myVotes>0?`(Du:${myVotes})`:''}
                        </div>
                        <div class="vote-pill">
                            <button class="vote-btn vote-down" onclick="window.vote(${c.id}, -1)" ${myVotes===0?'disabled':''}>üëé</button>
                            <span style="font-weight:bold; font-size:1.2rem; min-width:25px; text-align:center;">${c.votes}</span>
                            <button class="vote-btn vote-up" onclick="window.vote(${c.id}, 1)" ${(MAX_VOTES-myVotedCards.length)<=0?'disabled':''}>üëç</button>
                        </div>
                    </div>
                `;
                document.getElementById(c.column).appendChild(el);
            });
        }
    </script>
</body>
</html>
