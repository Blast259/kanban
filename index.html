<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lean Coffee | Agile Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Modern f√§rgpalett (Slate Dark) */
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-card: #334155;
            --bg-input: #1e293b;
            
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --primary: #38bdf8; /* Sky Blue */
            --primary-hover: #0ea5e9;
            
            --success: #4ade80; /* Soft Green */
            --danger: #f87171; /* Soft Red */
            --border: #475569;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 0.5rem; /* 8px */
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif; /* Professionellt typsnitt */
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* F√∂rhindra dubbla scrollbars */
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.025em;
        }

        .brand-badge {
            background-color: var(--primary);
            color: #0f172a;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stat-pill {
            background: rgba(255,255,255,0.05);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Input Section --- */
        .controls-area {
            padding: 1.5rem 2rem 0.5rem 2rem;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            width: 100%;
            background: var(--bg-surface);
            padding: 6px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: border-color 0.2s;
        }

        .input-group:focus-within {
            border-color: var(--primary);
        }

        #new-card-text {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
        }

        #add-btn {
            background-color: var(--primary);
            color: #0f172a;
            border: none;
            border-radius: 8px;
            padding: 0 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #add-btn:hover { background-color: var(--primary-hover); }

        /* --- Board Layout --- */
        .board {
            flex: 1;
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            overflow-x: auto;
            align-items: flex-start; /* Viktigt f√∂r att kolumner ska ha r√§tt h√∂jd */
        }

        .column {
            background-color: var(--bg-surface);
            border-radius: 12px;
            flex: 1;
            min-width: 320px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            height: 100%; /* Fyll h√∂jden */
            max-height: calc(100vh - 180px); /* Justera s√• de inte g√•r utanf√∂r sk√§rmen */
        }

        .column-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-header h2 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .task-list {
            flex: 1;
            padding: 1rem;
            overflow-y: auto; /* Scroll inuti kolumnen */
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Scrollbar styling */
        .task-list::-webkit-scrollbar { width: 6px; }
        .task-list::-webkit-scrollbar-track { background: transparent; }
        .task-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Drag over effekt */
        .task-list.drag-over {
            background-color: rgba(56, 189, 248, 0.05);
            border: 2px dashed var(--primary);
            border-radius: 8px;
        }

        /* --- Card Styles --- */
        .card {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            cursor: grab;
            border: 1px solid transparent;
            border-left: 4px solid transparent; /* Plats f√∂r anv√§ndarf√§rg */
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: rgba(255,255,255,0.05);
        }

        .card:active { cursor: grabbing; }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }

        .card-text {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            flex: 1;
        }

        /* Action Buttons (Edit/Delete) */
        .card-actions-top {
            display: flex;
            gap: 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .card:hover .card-actions-top { opacity: 1; }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
        .delete-btn:hover { color: var(--danger); background-color: rgba(248, 113, 113, 0.1); }

        /* Bottom Row (Voting) */
        .card-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 10px;
            margin-top: 5px;
        }

        .card-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .vote-pill {
            display: flex;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            border-radius: 20px;
            padding: 2px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .vote-btn {
            background: none;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .vote-btn:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
        .vote-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .vote-up:hover:not(:disabled) { color: var(--success); }
        .vote-down:hover:not(:disabled) { color: var(--danger); }

        .vote-count {
            padding: 0 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 24px;
            text-align: center;
        }

        .my-vote-badge {
            font-size: 0.7rem;
            color: var(--success);
            background: rgba(74, 222, 128, 0.1);
            padding: 1px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        #status {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <div style="font-size: 1.5rem;">‚òï</div>
            <div>
                <h1>LEAN COFFEE</h1>
            </div>
            <span class="brand-badge">BETA</span>
        </div>
        
        <div class="user-panel">
            <div class="stat-pill">
                <span style="color:var(--text-muted)">Din f√§rg:</span>
                <span id="my-color-box" style="display:block; width:12px; height:12px; border-radius:50%; box-shadow: 0 0 5px rgba(255,255,255,0.2);"></span> 
            </div>
            <div class="stat-pill">
                <span style="color:var(--text-muted)">R√∂ster kvar:</span>
                <span id="votes-left" style="font-weight:700; color:var(--primary);">5</span>
            </div>
        </div>
    </header>

    <div class="controls-area">
        <div class="input-group">
            <input type="text" id="new-card-text" placeholder="Vad vill du diskutera? Skriv h√§r...">
            <button id="add-btn" title="L√§gg till">+</button>
        </div>
    </div>

    <div class="board">
        <div class="column">
            <div class="column-header">
                <h2>F√∂rslag</h2>
                <span style="font-size:1.2em; opacity:0.5;">üí°</span>
            </div>
            <div class="task-list" id="proposal"></div>
        </div>

        <div class="column">
            <div class="column-header">
                <h2>Diskutera</h2>
                <span style="font-size:1.2em; opacity:0.5;">üó£Ô∏è</span>
            </div>
            <div class="task-list" id="discuss"></div>
        </div>

        <div class="column">
            <div class="column-header">
                <h2>Klart</h2>
                <span style="font-size:1.2em; opacity:0.5;">‚úÖ</span>
            </div>
            <div class="task-list" id="done"></div>
        </div>
    </div>

    <div id="status">Connecting...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --------------------------------------------------------------
        // KONFIGURATION - Klistra in dina uppgifter h√§r nedanf√∂r!
        // --------------------------------------------------------------
        const firebaseConfig = {
		  apiKey: "AIzaSyCHrUufAISfVGwGICTDcVaWGt0vzLVRFpk",
		  authDomain: "team-kanban.firebaseapp.com",
		  databaseURL: "https://team-kanban-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "team-kanban",
		  storageBucket: "team-kanban.firebasestorage.app",
		  messagingSenderId: "457664936790",
		  appId: "1:457664936790:web:a77f6fe962b365fb1034f7"

        };
        // --------------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let cards = [];
        const MAX_VOTES = 5;
        
        const userColor = localStorage.getItem('userColor') || '#' + Math.floor(Math.random()*16777215).toString(16);
        localStorage.setItem('userColor', userColor);
        document.getElementById('my-color-box').style.backgroundColor = userColor;

        let myVotedCards = JSON.parse(localStorage.getItem('myVotedCards')) || [];
        
        function updateVotesDisplay() {
            const votesLeft = MAX_VOTES - myVotedCards.length;
            document.getElementById('votes-left').innerText = votesLeft;
        }

        const cardsRef = ref(db, 'kanban/cards');
        
        onValue(cardsRef, (snapshot) => {
            document.getElementById('status').innerText = "üü¢ Connected";
            document.getElementById('status').style.color = "var(--success)";
            const data = snapshot.val();
            cards = data ? data : [];
            cards.sort((a, b) => b.votes - a.votes);
            renderBoard();
        });

        function saveToFirebase() {
            document.getElementById('status').innerText = "üü° Syncing...";
            document.getElementById('status').style.color = "var(--primary)";
            set(cardsRef, cards).catch(e => alert("Kunde inte spara: " + e.message));
        }

        // --- SKAPA ---
        window.createCard = function() {
            const input = document.getElementById('new-card-text');
            const text = input.value.trim();
            if (!text) return;

            const newCard = {
                id: Date.now(),
                text: text,
                column: 'proposal',
                color: userColor,
                votes: 0
            };

            cards.push(newCard);
            input.value = '';
            saveToFirebase();
        }
        document.getElementById('add-btn').addEventListener('click', createCard);
        
        document.getElementById('new-card-text').addEventListener("keypress", function(event) {
            if (event.key === "Enter") window.createCard();
        });

        // --- REDIGERA ---
        window.editCard = function(id) {
            const card = cards.find(c => c.id === id);
            if (!card) return;
            const newText = prompt("Redigera texten:", card.text);
            if (newText !== null && newText.trim() !== "") {
                card.text = newText.trim();
                saveToFirebase();
            }
        };

        // --- TA BORT ---
        window.deleteCard = function(id) {
            if(confirm("Vill du ta bort denna lapp?")) {
                cards = cards.filter(c => c.id !== id);
                if(myVotedCards.includes(id)) {
                    myVotedCards = myVotedCards.filter(vId => vId !== id);
                    localStorage.setItem('myVotedCards', JSON.stringify(myVotedCards));
                    updateVotesDisplay();
                }
                saveToFirebase();
            }
        };

        // --- R√ñSTNING ---
        window.addVote = function(id) {
            if (myVotedCards.length >= MAX_VOTES) {
                // G√∂r en liten "shake" animation eller liknande om vi vill vara fancy, 
                // men alert duger f√∂r nu.
                alert("Du har slut p√• r√∂ster!");
                return;
            }
            const cardIndex = cards.findIndex(c => c.id === id);
            if (cardIndex !== -1) {
                cards[cardIndex].votes++;
                myVotedCards.push(id);
                localStorage.setItem('myVotedCards', JSON.stringify(myVotedCards));
                saveToFirebase();
            }
        };

        window.removeVote = function(id) {
            if (!myVotedCards.includes(id)) return; 
            const cardIndex = cards.findIndex(c => c.id === id);
            if (cardIndex !== -1) {
                if (cards[cardIndex].votes > 0) cards[cardIndex].votes--;
                const indexToRemove = myVotedCards.indexOf(id);
                if (indexToRemove > -1) {
                    myVotedCards.splice(indexToRemove, 1);
                }
                localStorage.setItem('myVotedCards', JSON.stringify(myVotedCards));
                saveToFirebase();
            }
        };

        // --- DRAG AND DROP ---
        window.allowDrop = (ev) => { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        window.leaveDrop = (ev) => { ev.currentTarget.classList.remove('drag-over'); }
        window.drag = (ev) => { ev.dataTransfer.setData("text/plain", ev.target.id); }

        window.drop = function(ev) {
            ev.preventDefault();
            const list = ev.currentTarget;
            list.classList.remove('drag-over');
            const cardId = parseInt(ev.dataTransfer.getData("text/plain"));
            const newColumnId = list.id;
            const cardIndex = cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1 && cards[cardIndex].column !== newColumnId) {
                cards[cardIndex].column = newColumnId;
                saveToFirebase();
            }
        }

        // --- RENDERING ---
        function renderBoard() {
            updateVotesDisplay();
            const votesLeft = MAX_VOTES - myVotedCards.length;

            ['proposal', 'discuss', 'done'].forEach(col => {
                document.getElementById(col).innerHTML = '';
            });

            cards.forEach(card => {
                const myVotesOnThisCard = myVotedCards.filter(id => id === card.id).length;
                
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.draggable = true;
                cardEl.id = card.id;
                cardEl.style.borderLeftColor = card.color;
                
                cardEl.addEventListener('dragstart', window.drag);

                const upDisabled = votesLeft <= 0;
                const downDisabled = myVotesOnThisCard === 0;
                
                // SVG Ikoner (enkla paths f√∂r att slippa bibliotek)
                const iconEdit = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                const iconTrash = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                const iconThumbUp = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>`;
                const iconThumbDown = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>`;

                const myVoteBadge = myVotesOnThisCard > 0 
                    ? `<span class="my-vote-badge">Du: ${myVotesOnThisCard}</span>` 
                    : '';

                cardEl.innerHTML = `
                    <div class="card-top">
                        <div class="card-text">${card.text}</div>
                        <div class="card-actions-top">
                            <button class="icon-btn" onclick="editCard(${card.id})" title="Redigera">${iconEdit}</button>
                            <button class="icon-btn delete-btn" onclick="deleteCard(${card.id})" title="Ta bort">${iconTrash}</button>
                        </div>
                    </div>
                    <div class="card-bottom">
                        <div class="card-meta">#${card.id.toString().slice(-4)} ${myVoteBadge}</div>
                        
                        <div class="vote-pill">
                            <button class="vote-btn vote-down" onclick="removeVote(${card.id})" ${downDisabled ? 'disabled' : ''} title="Ta bort r√∂st">
                                ${iconThumbDown}
                            </button>
                            <span class="vote-count">${card.votes}</span>
                            <button class="vote-btn vote-up" onclick="addVote(${card.id})" ${upDisabled ? 'disabled' : ''} title="R√∂sta">
                                ${iconThumbUp}
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById(card.column).appendChild(cardEl);
            });

            document.querySelectorAll('.task-list').forEach(list => {
                list.ondrop = window.drop;
                list.ondragover = window.allowDrop;
                list.ondragleave = window.leaveDrop;
            });
        }
    </script>
</body>
</html>
